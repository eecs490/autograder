#! /usr/bin/env bash
export CARGO_INCREMENTAL=0
export RUSTFLAGS="-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Zno-landing-pads"
cargo build --manifest-path /autograder/assignment/Cargo.toml
cargo test --manifest-path /autograder/assignment/Cargo.toml
zip -0 /ccov.zip `find /autograder \( -name "submission*.gc*" \) -print`
grcov "/ccov.zip" -s /autograder -t lcov --llvm --branch --ignore-not-existing -o /lcov.info
mkdir -p results
cargo run --manifest-path=/autograder/assignment/Cargo.toml /autograder/assignment/Cargo.toml /autograder/results/results.json /lcov.info
