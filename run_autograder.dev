#! /usr/bin/env bash
source_dir=${1:-"/autograder"}
assignment_path=${2:-"/autograder/submission/assignment/Cargo.toml"}
results_path=${3:-"/autograder/results/results.json"}
#export RUSTUP_HOME=/usr/local/rustup \
#export CARGO_HOME=/usr/local/cargo \
#export PATH=/usr/local/cargo/bin:$PATH \
#export RUST_VERSION=1.41.0
#source "/usr/local/cargo/env"
lcov_dir="ccov"
lcov_path="$lcov_dir/lcov.info"
cargo test --manifest-path="$assignment_path"
mkdir "$lcov_dir"
zip -0 "$lcov_dir/ccov.zip" $(find . \( -name "submission*.gc*" \) -print)
grcov "$lcov_dir/ccov.zip" -s $source_dir -t lcov --llvm --branch --ignore-not-existing -o "$lcov_path"
cargo run --manifest-path="$assignment_path" "$assignment_path" "$results_path" "$lcov_path"
